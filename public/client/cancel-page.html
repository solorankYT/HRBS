<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancellation Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css"/>
    <style>
        /* Booking Actions Page (Rebooking & Cancellation) */
.booking-actions-section {
  font-family: "Poppins", sans-serif;
}

.booking-sidebar .list-group-item {
  border: none;
  border-left: 3px solid transparent;
  border-radius: 0;
  color: #1a2332;
  font-weight: 500;
  transition: var(--transition-fast);
}

.booking-sidebar .list-group-item.active {
  border-left: 3px solid var(--luxury-red);
  color: var(--luxury-red);
  background: none;
}

.booking-box {
  border: 1px solid var(--luxury-red);
  padding: 2rem;
  background: #fff;
}

.section-title {
  color: var(--luxury-red);
  font-family: "Playfair Display", serif;
}

.form-control {
  border: 1px solid var(--luxury-red);
  border-radius: 0;
  font-size: 0.9rem;
}

.form-control:focus {
  border-color: var(--luxury-red-hover);
  box-shadow: none;
}

textarea.form-control {
  resize: none;
}

.request-btn {
  background: var(--luxury-red);
  color: #fff;
  font-size: 0.9rem;
  border: none;
  border-radius: 4rem;
  padding: 0.5rem 1.3rem;
  transition: var(--transition-fast);
}

.request-btn:hover {
  background: darkred;
}/* Custom Room Dropdown */
.room-dropdown-btn {
  border: 1px solid var(--luxury-red);
  background: #fff;
  color: #1a2332;
  border-radius: 0;
  font-size: 0.9rem;
  text-align: left;
  padding: 0.45rem 0.75rem;
}

.room-dropdown-btn:focus {
  box-shadow: none;
  border-color: var(--luxury-red-hover);
}

.room-dropdown-btn i {
  color: var(--luxury-red);
  font-size: 0.9rem;
}

.dropdown-menu {
  border: 1px solid var(--luxury-red);
  border-radius: 0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.dropdown-item {
  font-size: 0.9rem;
  color: #1a2332;
}

.dropdown-item:hover {
  background: var(--luxury-red);
  color: #fff;
}


    </style>
</head>
<body>
        <!-- Header -->
    <header class="header">
      <div class="header-container">
        <div class="header-content">
          <a href="index.html" class="logo">
            <!-- <img src="vm-logo.jpg" alt="Victoria Mansions Logo" class="logo-img"> -->
            <span class="logo-text">Logo</span>
          </a>
          <nav class="nav">
            <a href="#" class="nav-link">Rooms</a>
            <a href="#" class="nav-link">About</a>
            <a href="#" class="nav-link">Amenities</a>
            <a href="#" class="nav-link">Contact</a>
            <a href="manage-booking.html" class="nav-link">My Bookings</a> 
          </nav>
        </div>
      </div>
    </header>


<section class="booking-actions-section py-5">
  <div class="container">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 mb-4 mb-md-0">
        <div class="list-group booking-sidebar">
          <a href="#rebooking" class="list-group-item list-group-item-action active" data-bs-toggle="tab">Rebooking</a>
          <a href="#cancellation" class="list-group-item list-group-item-action" data-bs-toggle="tab">Cancellation</a>
        </div>
      </div>

      <!-- Main content -->
      <div class="col-md-9">
        <div class="tab-content">
          <!-- Rebooking Tab -->
        <div class="tab-pane fade show active" id="rebooking">
              <h3 class="mb-4 section-title">Rebooking</h3>
              <div class="booking-box">
                <form id="rebookForm">
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Reservation ID:</label>
                    <input type="text" class="form-control" id="rebookRef" readonly>
                  </div>

                  <!-- Current Schedule -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Current Schedule:</label>
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="small text-muted">Check-In:</label>
                        <input type="date" class="form-control" id="currentCheckIn" readonly>
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="small text-muted">Check-Out:</label>
                        <input type="date" class="form-control" id="currentCheckOut" readonly>
                      </div>
                    </div>
                  </div>

                  <!-- New Schedule -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">New Schedule:</label>
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="small text-muted">Check-In:</label>
                        <input type="date" class="form-control" id="rebookCheckIn" required>
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="small text-muted">Check-Out:</label>
                        <input type="date" class="form-control" id="rebookCheckOut" required>
                      </div>
                    </div>
                  </div>

                  <div class="text-end">
                    <button type="submit" class="btn request-btn" id="rebookBtn">Request Rebook</button>
                  </div>
                </form>
              </div>
            </div>



          <!-- Cancellation Tab -->
          <div class="tab-pane fade" id="cancellation">
            <h3 class="mb-4 section-title">Cancellation</h3>
            <div class="booking-box">
              <form id="cancelForm">
                <div class="row mb-3">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Reservation ID:</label>
                    <input type="text" class="form-control" id="cancelRef" readonly>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Room Type:</label>
                    <input type="text" class="form-control" id="cancelRoom" readonly>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">Schedule:</label>
                  <div class="row">
                    <div class="col-md-6 mb-2">
                      <label class="small text-muted">Check-In:</label>
                      <input type="date" class="form-control" id="cancelCheckIn" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                      <label class="small text-muted">Check-Out:</label>
                      <input type="date" class="form-control" id="cancelCheckOut" readonly>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">Reason for Cancellation:</label>
                  <textarea class="form-control" rows="4" id="cancelReason"></textarea>
                </div>

                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="terms">
                  <label class="form-check-label small" for="terms">
                    Accept Terms & Conditions about Cancellation Rules and Regulations
                  </label>
                </div>

                <div class="text-end">
                  <button type="submit" class="btn request-btn">Request</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

    
<footer class="footer">
  <div class="footer-container">
    <!-- Logo -->
    <div class="footer-logo">
      <img src="vm-logo-nobg.png" alt="Logo">
    </div>

    <!-- <p class="footer-tagline">Stay simple. Stay comfortable.</p> -->

    <!-- Links Row 1 -->
    <div class="footer-links">
      <a href="#">About Us</a>
      <span class="divider">|</span>
      <a href="#">Privacy Policy</a>
      <span class="divider">|</span>
      <a href="#">Terms & Conditions</a>
      <span class="divider">|</span>
      <a href="#">Contact Us</a>
      <span class="divider">|</span>
      <a href="feedback.html">Feedback</a>
    </div>

    <!-- Links Row 2 -->
    <div class="footer-links">
      <a href="manage-booking.html">Manage Booking</a>
      <span class="divider">|</span>
      <a href="#">Facebook</a>
      <span class="divider">|</span>
      <a href="#">Instagram</a>
    </div>

    <!-- Copyright -->
    <div class="footer-divider-line"></div>
    <p class="footer-copy">© 2025. All rights reserved.</p>
  </div>
    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function selectRoom(roomName) {
    document.getElementById('selectedRoom').textContent = roomName;
    }
    </script>

</footer>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');
  if (!ref) return alert('No booking reference found');

  try {
    const res = await fetch(`/api/guest/bookings/${ref}/showCancel`);
    if (!res.ok) throw new Error();
    const booking = await res.json();

    // Fill cancellation fields
    document.getElementById('cancelRef').value = booking.reference;
    document.getElementById('cancelRoom').value = booking.rooms?.[0]?.room?.room_type ?? '—';
    document.getElementById('cancelCheckIn').value = booking.check_in;
    document.getElementById('cancelCheckOut').value = booking.check_out;

    // Fill rebooking fields
    document.getElementById('rebookRef').value = booking.reference;
    document.getElementById('currentCheckIn').value = booking.check_in;
    document.getElementById('currentCheckOut').value = booking.check_out;

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rebookCheckIn').min = today;
    document.getElementById('rebookCheckOut').min = today;

    document.getElementById('rebookCheckIn').addEventListener('change', e => {
      document.getElementById('rebookCheckOut').min = e.target.value;
    });

  } catch {
    alert('Unable to load booking details');
  }
});
</script>


<script>
document.getElementById('cancelForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');

  if (!document.getElementById('terms').checked) {
    alert('You must accept the cancellation terms');
    return;
  }

  const reason = document.getElementById('cancelReason').value;

  const res = await fetch(`/api/guest/bookings/${ref}/cancel`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      cancellation_reason: reason
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message || 'Cancellation failed');
    return;
  }

  alert('Booking cancelled successfully');
  window.location.href = 'manage-booking.html';
});
</script>




<!-- rebook -->
<script>

document.getElementById('rebookForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const btn = document.getElementById('rebookBtn');
  btn.disabled = true;
  btn.textContent = 'Processing...';

  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');

  const newCheckIn = document.getElementById('rebookCheckIn').value;
  const newCheckOut = document.getElementById('rebookCheckOut').value;

  if (!newCheckIn || !newCheckOut) {
    alert('Please select new dates');
    btn.disabled = false;
    btn.textContent = 'Request Rebook';
    return;
  }

  if (newCheckOut <= newCheckIn) {
    alert('Check-out must be after check-in');
    btn.disabled = false;
    btn.textContent = 'Request Rebook';
    return;
  }
  
  if (newCheckIn < new Date().toISOString().split('T')[0]) {
    alert('Check-in cannot be in the past');
    btn.disabled = false;
    btn.textContent = 'Request Rebook';
    return;
  }
  
  try {
    const res = await fetch(`/api/guest/bookings/${ref}/rebook`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        new_check_in: newCheckIn,
        new_check_out: newCheckOut,
      })
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.message || 'Rebooking failed');
      btn.disabled = false;
      btn.textContent = 'Request Rebook';
      return;
    }

    alert('Booking rebooked successfully!');
    window.location.href = 'manage-booking.html';

  } catch (error) {
    alert('Something went wrong.');
    btn.disabled = false;
    btn.textContent = 'Request Rebook';
  }
});

</script>




</body>
</html>